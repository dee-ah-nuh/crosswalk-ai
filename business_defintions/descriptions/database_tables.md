# Interactive Crosswalk & ETL Helper - Database Tables Documentation

## Overview

This document provides a comprehensive breakdown of all database tables powering the Interactive Crosswalk & ETL Helper application and how they get populated with data.

## Current Database Status

**Database Type:** PostgreSQL  
**Total Tables:** 14 tables  
**Current Data Volume:**
- `pi20_data_model`: 827+ records (actively used data model)
- `crosswalk_template`: 332 records (main working data)
- `data_model_fields`: 827 records (legacy/unused seed data)
- Other tables: Empty (will be populated as users work with the system)

---

## Core Active Tables

### 1. `pi20_data_model` ⭐ **ACTIVE DATA MODEL TABLE**
**Purpose:** The real data model table that defines the standardized target schema for column mappings. This is the table actively used by all API endpoints and the frontend application.

**Schema:**
```sql
CREATE TABLE pi20_data_model (
    id INTEGER PRIMARY KEY,
    schema_layer VARCHAR NOT NULL,           -- RAW, CLEANSE, CURATED
    table_name VARCHAR NOT NULL,             -- Target table name (e.g., PROVIDER, CLAIM)
    column_name VARCHAR NOT NULL,            -- Target column name
    data_type VARCHAR,                       -- Data type (VARCHAR, TIMESTAMP_NTZ, etc.)
    description TEXT,                        -- Human-readable description
    is_standard_field BOOLEAN DEFAULT TRUE,  -- Whether field is standard or custom
    is_case_sensitive BOOLEAN DEFAULT FALSE, -- Case sensitivity requirements
    source_layer VARCHAR DEFAULT 'EXCEL_DATA_MODEL', -- Data source layer
    validation_rules TEXT                    -- Validation and metadata rules
);
```

**Data Population:**
- **How:** Loaded from Excel Data Model sheet via `load_real_datamodel.py`
- **When:** When real data model is imported from Excel files
- **Source File:** `data_model_from_excel.csv` (generated by `extract_datamodel_sheet.py`)
- **File Headers:** `IN_CROSSWALK,TABLE_NAME,COLUMN_NAME,COLUMN_TYPE,COLUMN_ORDER,COLUMN_COMMENT,TABLE_CREATION_ORDER,IS_MANDATORY,MANDATORY_PROV_TYPE,MCDM_MASKING_TYPE,IN_EDITS,KEY`

**Content:** Real healthcare data model covering:
- **PROVIDER table:** 200+ fields including NPI, provider names, addresses, specialties
- **CLAIM table:** 300+ fields including claim IDs, amounts, dates, procedures  
- **MEMBER table:** Fields for member/patient information
- **PLAN table:** Insurance plan and coverage details
- All fields include proper data types, descriptions, and business rules

**API Usage:**
- `/api/datamodel/fields` - Main data model query endpoint
- `/api/datamodel/suggest-mapping` - AI mapping suggestions
- `/api/datamodel/validate-mapping` - Validation rules
- `/api/datamodel/schema-layers` - Available schema layers
- `/api/datamodel/tables` - Available tables

**Example Records:**
```
CURATED | PROVIDER | PROV_FULL_NAME         | VARCHAR | Provider full name                    | TRUE  | TRUE
CURATED | PROVIDER | NPI                    | VARCHAR | National Provider Identifier         | TRUE  | FALSE  
CURATED | CLAIM    | CLAIM_ID               | VARCHAR | Unique identifier for the claim      | TRUE  | FALSE
```

---

### 2. `crosswalk_template` ⭐ **MAIN WORKING TABLE**
**Purpose:** The heart of the application - stores all column mapping configurations between source data and target data model.

**Schema:**
```sql
CREATE TABLE crosswalk_template (
    id INTEGER PRIMARY KEY,
    
    -- Core identification fields
    client_id VARCHAR(100) NOT NULL,              -- Client identifier
    source_column_order INTEGER,                  -- Display order
    source_column_name VARCHAR(255) NOT NULL,     -- Source column name
    file_group_name VARCHAR(100) NOT NULL,        -- Data category (CLAIM, MEMBER, etc.)
    mcdm_column_name VARCHAR(255),                -- Target model column
    
    -- Data flow control
    in_model VARCHAR(10) DEFAULT 'Y',             -- Include in model (Y/N/U/N/A)
    mcdm_table VARCHAR(100),                      -- Target table name
    custom_field_type VARCHAR(50),                -- Custom field type
    
    -- Data profiling fields
    data_profile_info TEXT,                       -- Main profile information
    profile_column_2 TEXT,                        -- Additional profile data
    profile_column_3 TEXT,
    profile_column_4 TEXT,
    profile_column_5 TEXT,
    profile_column_6 TEXT,
    
    -- Transformation and formatting
    source_column_formatting TEXT,                -- Transformation rules/formulas
    skipped_flag BOOLEAN DEFAULT FALSE,           -- Skip this field flag
    
    -- Additional metadata fields
    additional_field_1 TEXT,                      -- Extensible metadata
    additional_field_2 TEXT,
    -- ... (up to additional_field_8)
    
    -- Enhanced fields (extended version)
    target_tables TEXT,                           -- Multiple target tables
    provider_file_group VARCHAR,                  -- Provider-specific grouping
    is_multi_table BOOLEAN DEFAULT FALSE,         -- Maps to multiple tables
    crosswalk_version VARCHAR DEFAULT '1.0',      -- Version tracking
    parent_mapping_id INTEGER,                    -- Hierarchical mappings
    reuse_from_client VARCHAR,                    -- Reuse mappings from other clients
    version_notes TEXT,                           -- Version change notes
    
    -- Data type inference
    inferred_data_type VARCHAR,                   -- Auto-detected data type
    custom_data_type VARCHAR,                     -- User-defined data type
    data_type_source VARCHAR DEFAULT 'INFERRED', -- Source of data type info
    
    -- File and join metadata
    source_file_name VARCHAR,                     -- Original file name
    join_key_column VARCHAR,                      -- For table joins
    join_table VARCHAR,                           -- Target join table
    join_type VARCHAR DEFAULT 'INNER',           -- Join type
    
    -- Review and approval workflow
    mcs_review_required BOOLEAN DEFAULT FALSE,    -- Requires review
    mcs_review_notes TEXT,                        -- Review comments
    mcs_review_status VARCHAR DEFAULT 'PENDING',  -- Review status
    mcs_reviewer VARCHAR,                         -- Reviewer name
    mcs_review_date TIMESTAMP,                    -- Review date
    
    -- Priority and completion tracking
    complexity_score INTEGER DEFAULT 1,           -- Mapping complexity (1-10)
    business_priority VARCHAR DEFAULT 'MEDIUM',   -- Business priority
    completion_status VARCHAR DEFAULT 'DRAFT',    -- Completion status
    
    -- Tracking
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Data Population:**
- **How:** Loaded from existing Excel crosswalk templates or created through the UI
- **When:** When users upload Excel files or manually create mappings
- **Current Data:** 332 mappings already loaded
- **Sources:** 
  - Excel template imports (via `load_template_data.py`)
  - Manual user input via web interface
  - Bulk imports from CSV files
  - Auto-mapping suggestions from AI system

---

### 3. `source_profiles`
**Purpose:** Container/project management for different data sources and client configurations.

**Schema:**
```sql
CREATE TABLE source_profiles (
    id INTEGER PRIMARY KEY,
    name VARCHAR NOT NULL,                    -- Profile/project name
    client_id VARCHAR,                        -- Associated client
    created_at TIMESTAMP,                     -- Creation timestamp
    updated_at TIMESTAMP,                     -- Last update
    has_physical_file BOOLEAN DEFAULT FALSE,  -- Whether there's an actual file
    raw_table_name VARCHAR                    -- Raw data table name
);
```

**Data Population:**
- **How:** Created when users start new crosswalk projects
- **When:** Project creation, file uploads, schema-only workflows
- **Current Data:** Empty (will populate as users create projects)

---

### 4. `source_columns`
**Purpose:** Details about individual columns from source data files, including sample values and inferred types.

**Schema:**
```sql
CREATE TABLE source_columns (
    id INTEGER PRIMARY KEY,
    profile_id INTEGER REFERENCES source_profiles(id),  -- Parent profile
    source_column VARCHAR NOT NULL,                     -- Column name
    sample_values_json TEXT,                            -- JSON array of sample values
    inferred_type VARCHAR                               -- Auto-detected data type
);
```

**Data Population:**
- **How:** Auto-populated when users upload CSV/Excel files
- **When:** File processing and column analysis
- **Process:** 
  1. File upload triggers column extraction
  2. System samples values from each column
  3. Data type inference runs on sample values
  4. Results stored as JSON for UI display

---

### 5. `crosswalk_mappings`
**Purpose:** Links source columns to target data model fields with transformation rules.

**Schema:**
```sql
CREATE TABLE crosswalk_mappings (
    id INTEGER PRIMARY KEY,
    profile_id INTEGER REFERENCES source_profiles(id),      -- Source profile
    source_column_id INTEGER REFERENCES source_columns(id), -- Source column
    model_table VARCHAR NOT NULL,                           -- Target table
    model_column VARCHAR NOT NULL,                          -- Target column
    is_custom_field BOOLEAN DEFAULT FALSE,                  -- Custom vs standard field
    custom_field_name VARCHAR,                              -- Custom field name
    transform_expression TEXT,                              -- Data transformation rules
    notes TEXT                                              -- Mapping notes
);
```

**Data Population:**
- **How:** Created through interactive mapping interface
- **When:** Users drag-drop or select mappings in the UI
- **Features:**
  - Manual mapping by users
  - AI-suggested mappings from auto_mapper system
  - Bulk mapping operations
  - Custom field creation

---

## Legacy Tables (Not Actively Used)

### `data_model_fields` ❌ **LEGACY TABLE**
**Status:** This table exists but is NOT used by the active application. It contains hardcoded seed data but all API endpoints query `pi20_data_model` instead.

**Purpose:** Originally stored reference data model - now replaced by `pi20_data_model`

**Schema:**
```sql
CREATE TABLE data_model_fields (
    id INTEGER PRIMARY KEY,
    model_table VARCHAR NOT NULL,        -- Target table name (CLAIM, PROVIDER, PLAN)
    model_column VARCHAR NOT NULL,       -- Target column name
    description TEXT,                    -- Human-readable description
    data_type VARCHAR,                   -- Data type (VARCHAR(50), DATE, etc.)
    required BOOLEAN DEFAULT FALSE,      -- Whether field is required
    unique_key BOOLEAN DEFAULT FALSE     -- Whether field is a unique key
);
```

**Data Population:**
- **How:** Automatically seeded during application startup via `seed_database.py`
- **When:** First time the application runs or when database is empty
- **Content:** Predefined hardcoded healthcare data model with 827 fields
- **Status:** ⚠️ This data is never queried by the live application

---

## Supporting Tables

### 6. `regex_rules`
**Purpose:** Validation rules for data quality checking using regular expressions.

### 7. `warehouse_configs`
**Purpose:** Configuration for optional data warehouse connections (Snowflake, etc.)

### 8. `client_profiles`
**Purpose:** Client-specific configurations and metadata.

### 9. `mapping_corrections`
**Purpose:** Machine learning feedback - stores user corrections to improve auto-mapping suggestions.

**Schema:**
```sql
CREATE TABLE mapping_corrections (
    id SERIAL PRIMARY KEY,
    source_column TEXT,              -- Original source column
    correct_target_table TEXT,       -- User-corrected target table
    correct_target_column TEXT,      -- User-corrected target column
    incorrect_suggestion TEXT,       -- What the AI suggested incorrectly
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## Data Flow and Population Process

### 1. **Real Data Model Loading (Primary Process)**
```
Excel Data Model File → extract_datamodel_sheet.py → data_model_from_excel.csv → load_real_datamodel.py → pi20_data_model
```

### 2. **Crosswalk Template Loading**
```
Excel Crosswalk File → load_template_data.py → crosswalk_template (332 records)
```

### 3. **Project Creation (User-Driven)**
```
User Creates Project → source_profiles → New record created
```

### 4. **File Upload (Automated Analysis)**
```
CSV/Excel Upload → File Processing → source_columns (with samples & types)
```

### 5. **Interactive Mapping (User + AI)**
```
User Maps Columns → crosswalk_mappings → Links source to target
Auto-Mapper AI → Suggests mappings → User corrects → mapping_corrections
```

---

## Key Relationships

```
source_profiles (1) ←→ (N) source_columns
source_profiles (1) ←→ (N) crosswalk_mappings  
source_profiles (1) ←→ (N) warehouse_configs

source_columns (1) ←→ (N) regex_rules
source_columns (1) ←→ (N) crosswalk_mappings

pi20_data_model ←→ crosswalk_mappings (via model_table + model_column)
pi20_data_model ←→ API endpoints (ACTIVE QUERIES)

data_model_fields (UNUSED - legacy seed data only)
```

---

## API Integration

**Active Data Model APIs (all query `pi20_data_model`):**
- `GET /api/datamodel/fields` - Main data model field listing
- `GET /api/datamodel/suggest-mapping` - AI mapping suggestions  
- `POST /api/datamodel/validate-mapping` - Validation against data model rules
- `GET /api/datamodel/schema-layers` - Available schema layers (RAW, CLEANSE, CURATED)
- `GET /api/datamodel/tables` - Available table names
- `GET /api/datamodel/field-info/{column_name}` - Detailed field information

**Frontend Integration:**
- All data model queries go through `frontend/src/services/dataModelApi.ts`
- Frontend consumes data from `pi20_data_model` via these API endpoints
- No direct database access from frontend

---

## Auto-Mapping Intelligence System

The application includes an AI-powered mapping system that:

1. **Loads Data Model:** Reads all fields from `pi20_data_model` (NOT from data_model_fields)
2. **Analyzes Source Columns:** Uses fuzzy string matching and pattern analysis
3. **Suggests Mappings:** Provides confidence-scored mapping suggestions
4. **Learns from Corrections:** Stores user feedback in `mapping_corrections`
5. **Improves Over Time:** Uses correction history to improve future suggestions

---

## Data Volumes and Performance

- **Active Data Model:** 827+ fields in `pi20_data_model` (real Excel data)
- **Legacy Seed Data:** 827 fields in `data_model_fields` (unused hardcoded data)
- **Active Mappings:** 332 crosswalk template records
- **User Data:** Tables start empty and grow with usage
- **Indexing:** Key columns indexed for performance (client_id, source_column_name, etc.)
- **Relationships:** Foreign keys ensure data integrity across related tables

## ⚠️ Important Notes

1. **`pi20_data_model` is the ACTIVE table** - all application queries use this table
2. **`data_model_fields` is LEGACY** - exists but unused by the live application
3. **Real data comes from Excel files** with the CSV header structure you specified
4. **All API endpoints query `pi20_data_model`** - this is what the frontend sees

The database design supports both small-scale individual projects and large enterprise deployments with thousands of mappings and multiple client configurations.